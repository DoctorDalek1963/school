\documentclass[a4paper, 12pt]{article}

\usepackage[english]{babel} % UK writing style
\usepackage[a4paper, top=15mm, bottom=15mm, left=50mm, right=20mm]{geometry} % Good margins

\usepackage[hidelinks]{hyperref}
\hypersetup{
	pdftitle = {Dyson - draft \#DRAFTNUMBER},
	pdfauthor = {Dyson}
}

\usepackage{csquotes}
\usepackage{setspace}

\usepackage{luacode}
\begin{luacode*}
do
	local whole_buf = ""
	local envname = "personalstatement"

	function readbuf(buf)
		whole_buf = whole_buf .. buf .. "\n"
	end

	function startrecording()
		luatexbase.add_to_callback("process_input_buffer", readbuf, "readbuf")
	end

	function stoprecording()
		luatexbase.remove_from_callback("process_input_buffer", "readbuf")

		local buf = whole_buf:gsub("\\end{" .. envname .. "}\n$","")
		buf = buf:gsub("\n$", "")

		local _, chars = buf:gsub(".", "")
		local _, words = buf:gsub("%S+", "")

		local info_string = string.format("\\par\\vspace{3ex}\\hfill %s words, %s characters", words, chars)
		tex.sprint(info_string)
	end
end
\end{luacode*}

\newenvironment{personalstatement}{\directlua{startrecording()}}{\directlua{stoprecording()}}

\begin{document}

\begin{center}
	\vspace*{3mm}
	\huge{\textbf{Dyson - draft \#DRAFTNUMBER}}
	\vspace*{10mm}
\end{center}

\setstretch{2.5}

\begin{personalstatement}
This is some simple text to test the new environment and lua code.
\end{personalstatement}

\end{document}
